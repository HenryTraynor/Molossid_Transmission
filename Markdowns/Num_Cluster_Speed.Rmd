---
title: "Epidemic Speed"
author: "Henry Traynor"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Sourcing}
files_functions <- list.files(path = "C:/Users/henry/Molossid_Transmission/Functions", pattern = "\\.R$", full.names = TRUE)
for(file in files_functions) {
  source(file)
}
```

```{r Parameters}
#Define SIR Model Parameters
SIR_parms  <- c(beta = 0.1, #transmission rate
                gamma = 0.03) # recovery rate

roost_parms <- c(num_roosts = 20,  # number of roosts
                 num_clusters = 3, # number of clusters
                 sd = 0.05, #avg distance from roost cluster
                 avg_N_max = 70, # roost size upper bound
                 min_N_max = 10) #minimum roost size
```

```{r Roost Creation}
roost_map <- roostMap(roost_parms)
roost_dist <- distMatrix(roost_parms[1], roost_map)

library(ggplot2)
ggplot(roost_map, aes(x,y, color=bin, label = lbl, size=N_max)) + geom_text() + xlim(0,1) + ylim(0,1)
```


```{r Roosts}
roosts <- data.frame(
  S = vector("numeric", length=roost_parms[1]),
  I = vector("numeric", length=roost_parms[1]),
  R = vector("numeric", length=roost_parms[1]),
  N = vector("numeric", length=roost_parms[1]),
  N_max = roost_map$N_max
)

#Populate Roosts
roosts$N <- round(roosts$N_max/1.5)
roosts$S <- roosts$N
roosts$S[1] <- roosts$S[1]-1
roosts$I <- roosts$N-roosts$S

#Total distances between any 2 roosts
total_dist <- 0
for(i in 1:roost_parms[1]) {
  for(j in 1:i) {
    total_dist <- total_dist + as.numeric(roost_dist[i,j])
  }
}

#Score, a measure of isolation. greater score ==> greater isolation
scores <- vector("numeric", length=roost_parms[1])
for(i in 1:roost_parms[1]) {
  tot <- sum(roost_dist[i,])
  scores[i] <- tot/total_dist
}
```

```{r Compute and Store Realizations}
series_list <- list()
num_days <- 50
max_clusters <- 3
for(i in 1:max_clusters) {
  temp <- list()
  temp[[1]] <- roosts
  for(j in 2:num_days) {
    roost_parms["num_clusters"] <- i
    temp[[j]] <- singleDay(temp[[j-1]],
                           roost_dist,
                           roost_parms,
                           SIR_parms,
                           "SIR",
                           scores,
                           phi_max=0.25)
  }
  series_list[[i]] <- temp
}
```

```{r Extraction}
df_peak <- data.frame(num_clusters = seq(1:max_clusters),
                      peak_index = vector(mode="integer", length=max_clusters),
                      peak_prop = vector(mode="numeric", length=max_clusters))
                   
for(i in 1:length(series_list)) {
  temp <- c()
  for(k in 1:length(series_list[[i]])) {
    temp[k] <- sum(series_list[[i]][[k]]$I)/sum(series_list[[i]][[k]]$N)
  }
  df_peak$peak_index[i] <- which.max(temp)
  df_peak$peak_prop[i] <- temp[which.max(temp)]
}
```

```{r Plot}
library(ggplot2)
library(gridExtra)
p <- ggplot(data=df_peak,
            aes(x=num_clusters, y=peak_prop)) + geom_line()
g <- ggplot(data=df_peak,
            aes(x=num_clusters, y=peak_index)) + geom_line()
grid.arrange(p,g)
```

```{r Now with average/sd values}
num_realizations=10 # number of realizations per number of clusters
num_days <- 50 # length of each time series (days)
max_clusters <- 10 #max number of clusters
df_peak <- data.frame(num_clusters = integer(),
                      peak_index = integer(),
                      peak_prop = numeric())
for(i in 1:num_realizations) {
  series_list <- list()
  for(p in 1:max_clusters) {
    temp <- list()
    temp[[1]] <- roosts
    for(q in 2:num_days) {
      roost_parms["num_clusters"] <- p
      temp[[q]] <- singleDay(temp[[q-1]],
                            roost_dist,
                            roost_parms,
                            SIR_parms,
                            "SIR",
                            scores,
                            phi_max=0.25)
    }
    series_list[[p]] <- temp
  }
  
  
  for(r in 1:length(series_list)) {
    temp <- c()
    for(k in 1:length(series_list[[r]])) {
      temp[k] <- sum(series_list[[r]][[k]]$I)/sum(series_list[[r]][[k]]$N)
    }
    bindvec <- c(num_clusters = r,
                 peak_index = which.max(temp),
                 peak_prop = temp[which.max(temp)])
    
    df_peak <- rbind(df_peak, bindvec)
  }
}
colnames(df_peak) <- c("num_clusters", "peak_index", "peak_prop")

# now we calculate average peak index and peak proportion by number of clusters. store with standard deviation

library(dplyr) 
df_summary <- df_peak %>%
  group_by(num_clusters) %>%
  summarise(
    mean_peak_index = mean(peak_index, na.rm = TRUE),
    sd_peak_index   = sd(peak_index, na.rm = TRUE),
    mean_peak_prop  = mean(peak_prop, na.rm = TRUE),
    sd_peak_prop    = sd(peak_prop, na.rm = TRUE)
  )

```

```{r Summary Plot}
library(gridExtra)
prop_summary_plot <- ggplot(df_summary, aes(x=num_clusters, y=mean_peak_prop)) +
  geom_point(size=3) +
  geom_line() +
  geom_errorbar(aes(ymin = mean_peak_prop - sd_peak_prop,
                    ymax = mean_peak_prop + sd_peak_prop),
                width = 0.2) +
  labs(x = "Number of clusters",
       y = "Average peak proportion ± 1 SD") +
  theme_minimal() 

index_summary_plot <- ggplot(df_summary, aes(x=num_clusters, y=mean_peak_index)) +
  geom_point(size=3) +
  geom_line() +
  geom_errorbar(aes(ymin = mean_peak_index - sd_peak_index,
                    ymax = mean_peak_index + sd_peak_index),
                width = 0.2) +
  labs(x = "Number of clusters",
       y = "Average peak index ± 1 SD") +
  theme_minimal()

grid.arrange(prop_summary_plot,
             index_summary_plot)
```