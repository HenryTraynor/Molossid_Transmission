---
title: "Main"
author: "Henry Traynor"
date: "`r Sys.Date()`"
output: html_document
---

```{r Initialization}
#Define SIR Model Parameters
SIR_parms  <- c(a = 0.06,   # birth rate
              b =0.04,     # death rate
              beta = 0.4,  # transmission rate
              nu = 0.02,   # loss of immunity
              alpha =0.5,  # disease induced death
              gamma = 0.5) # recovery rate

phi <- 0.1 # percent roost infidelity

roost_parms <- c(num_roosts = 100,  # number of roosts
                 num_clusters = 2, # number of clusters
                 sd = 0.1)           # standard distance from cluster center
```

```{r Roost Creation}
source("cluster_map.R")
roost_map <- cluster_map(roost_parms[1],
                         roost_parms[2],
                         roost_parms[3])

#Matrix to store distance values between roosts
{roost_dist <- matrix(nrow=roost_parms[1],
                     ncol=roost_parms[1])
colnames(roost_dist) <- as.character(seq(1:roost_parms[1]))}

#Iterate through roosts and calculate distances between them, creates symmetric matrix with zero diagonal
for(i in 1:roost_parms[1]) {
  for(j in 1:roost_parms[1]) {
    roost_dist[i,j] = sqrt((roost_map$x[j]-roost_map$x[i])^2+(roost_map$y[j]-roost_map$y[i])^2)
  }
}

plot(roost_map$x, roost_map$y)
```

```{r Roosts}
roosts <- data.frame(
  S = vector("numeric", length=roost_parms[1]),
  I = vector("numeric", length=roost_parms[1]),
  R = vector("numeric", length=roost_parms[1]),
  N = vector("numeric", length=roost_parms[1])
)

#Populate Roosts
roosts$N <- 15
roosts$S <- roosts$N-1
roosts$I <- 1
```

```{r Movement}
movement <- function(roosts, parms) {
  phi <- parms[7] # roost fidelity
  
  #matrix that stores total number of bats leaving roost i and traveling to roost j
  emigrant_bats <- matrix(ncol=roost_parms[1], nrow=roost_parms[1])
  for(i in 1:roost_parms[1]) {
    for(j in 1:roost_parms[1]) {
      if(i == j) {
        total_emigrants_ij <- 0
      }
      else {
        # infidelity*num_bats*(1-proportion of distance)
        total_emigrants_ij <- phi * roosts$N[i] * (1- (roost_dist[i,j] / sum(roost_dist[i,])))
      }
      emigrant_bats[i,j] <- total_emigrants_ij
    }
  }
  #subtract emigrants from their home roosts
  for(i in 1:roost_parms[1]) {
    roosts$S[i] <- roosts$S[i] - (sum(emigrant_bats[i,])*roosts$S[i]/roosts$N[i]) # sum by row or column?
    roosts$I[i] <- roosts$I[i] - (sum(emigrant_bats[i,])*roosts$I[i]/roosts$N[i])
    roosts$R[i] <- roosts$R[i] - (sum(emigrant_bats[i,])*roosts$R[i]/roosts$N[i])
    roosts$N[i] <- roosts$S[i] + roosts$I[i] + roosts$R[i]
  }
  
  #add immigrants
  for(i in 1:roost_parms[1]) {
    
  }
}
```

```{r deSolve & Plot}
#Solve
library(deSolve)
output <- ode(y_init,
              times,
              SIR,
              parms) 
#needs to be given (in order) initial values of the variables, times for output, the name of the function to solve, the parameters

summary(output) 
#returns a matrix with columns for time and each of the variables

head(output)

#Visualise
plot(output)
plot(output[,"S"],output[,"I"],type="l")

#Plot all three variables on the one set of axes
output.data<-as.data.frame(output)
par(mfrow=c(1,1),cex=2,lwd=2,las=1)

{plot(S~time,data=output.data,type="l",ylim=c(0,10),ylab="N")
lines(I~time,data=output.data,col="red")
lines(R~time,data=output.data,col="blue")}
```